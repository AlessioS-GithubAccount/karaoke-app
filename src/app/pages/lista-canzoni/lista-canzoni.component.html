<table class="table table-striped">
  <thead>
    <tr>
      <th>{{ 'song_list.labels.status' | translate }}</th>
      <th>#</th>
      <th>{{ 'song_list.labels.name' | translate }}</th>
      <th>{{ 'song_list.labels.artist' | translate }}</th>
      <th>{{ 'song_list.labels.song' | translate }}</th>
      <th *ngIf="isAdmin">{{ 'song_list.labels.key' | translate }}</th>
      <th *ngIf="isAdmin">{{ 'song_list.labels.notes' | translate }}</th>
      <th>{{ 'song_list.labels.join' | translate }}</th>
      <th>{{ 'song_list.labels.vote' | translate }}</th>
      <th>{{ 'song_list.labels.actions' | translate }}</th>
    </tr>
  </thead>
  <tbody cdkDropList (cdkDropListDropped)="onDrop($event)">
    <tr cdkDrag *ngFor="let canzone of canzoni; let i = index" [id]="'canzone-' + canzone.id">
      <!-- Stato cantata -->
      <td *ngIf="isAdmin">
        <button (click)="toggleCantata(i)" class="btn btn-sm"
                [ngClass]="canzoni[i].cantata ? 'btn-danger' : 'btn-success'">
          {{ canzoni[i].cantata ? ('song_list.status_values.sung' | translate) : ('song_list.status_values.to_sing' | translate) }}
        </button>
      </td>
      <td *ngIf="!isAdmin">
        <button class="btn btn-sm"
                [ngClass]="canzoni[i].cantata ? 'btn-danger' : 'btn-success'"
                disabled [style.opacity]="'1'">
          {{ canzoni[i].cantata ? ('song_list.status_values.sung' | translate) : ('song_list.status_values.to_sing' | translate) }}
        </button>
      </td>

      <!-- Numero -->
      <td>{{ i + 1 }}</td>

      <!-- Nome -->
      <td *ngIf="editingIndex === i">
        <input *ngIf="editedCanzone" [(ngModel)]="editedCanzone.nome" class="form-control form-control-sm" />
      </td>
      <td *ngIf="editingIndex !== i">{{ canzone.nome }}</td>

      <!-- Artista -->
      <td *ngIf="editingIndex === i">
        <input *ngIf="editedCanzone" [(ngModel)]="editedCanzone.artista" class="form-control form-control-sm" />
      </td>
      <td *ngIf="editingIndex !== i">{{ canzone.artista }}</td>

      <!-- Canzone -->
      <td *ngIf="editingIndex === i">
        <input *ngIf="editedCanzone" [(ngModel)]="editedCanzone.canzone" class="form-control form-control-sm" />
      </td>
      <td *ngIf="editingIndex !== i">{{ canzone.canzone }}</td>

      <!-- TonalitÃ  -->
      <td *ngIf="isAdmin">
        <ng-container *ngIf="editingIndex === i; else tonalitaStatic">
          <input *ngIf="editedCanzone" [(ngModel)]="editedCanzone.tonalita" class="form-control form-control-sm" />
        </ng-container>
        <ng-template #tonalitaStatic>{{ canzone.tonalita }}</ng-template>
      </td>

      <!-- Note -->
      <td *ngIf="isAdmin">
        <ng-container *ngIf="editingIndex === i; else noteStatic">
          <input *ngIf="editedCanzone" [(ngModel)]="editedCanzone.note" class="form-control form-control-sm" />
        </ng-container>
        <ng-template #noteStatic>{{ canzone.note }}</ng-template>
      </td>

      <!-- Partecipa -->
      <td>
        <!-- Bottone -->
        <button class="btn btn-success mb-1"
          [disabled]="!puoPartecipare || partecipazioneCompleta(canzone) || !canzone.accetta_partecipanti"
          (click)="partecipaAllaCanzone(canzone)">
          {{ 'song_list.labels.join' | translate }}
        </button>

        <!-- Input nome -->
        <div *ngIf="mostraInputPartecipazione[canzone.id]" class="mt-1">
          <input type="text"
            [(ngModel)]="nomePartecipanteMap[canzone.id]"
            placeholder="Il tuo nome"
            class="form-control form-control-sm mb-1" />

          <button class="btn btn-primary btn-sm me-1"
            (click)="partecipaAllaCanzone(canzone)">
            Invia
          </button>

          <button class="btn btn-secondary btn-sm"
            (click)="mostraInputPartecipazione[canzone.id] = false">
            Annulla
          </button>
        </div>

        <!-- Messaggi -->
        <div *ngIf="partecipazioneCompleta(canzone)" class="text-warning small mt-1">
          {{ 'song_list.participation.full' | translate }}
        </div>
        <div *ngIf="!canzone.accetta_partecipanti" class="text-muted small mt-1">
          {{ 'song_list.participation.not_available' | translate }}
        </div>
      </td>

      <!-- Colonna Voto con emoji -->
      <td>
        <span *ngFor="let emoji of emojisVoto"
              (click)="votaCanzone(i, emoji)"
              [style.cursor]="'pointer'"
              [style.fontSize]="'1.5rem'"
              [title]="'song_list.labels.vote' | translate:{ emoji: emoji }"
              [class.selected]="canzoni[i].votoEmoji === emoji"
              style="margin-right: 6px;">
          {{ emoji }}
        </span>
      </td>

      <!-- Azioni -->
      <td *ngIf="canEditOrDelete(canzone)">
        <button *ngIf="editingIndex !== i" class="btn btn-sm btn-warning me-1" (click)="modifica(i)">
          {{ 'song_list.actions.edit' | translate }}
        </button>
        <button *ngIf="editingIndex === i" class="btn btn-sm btn-success me-1" (click)="salvaModifica(i)">
          {{ 'song_list.actions.save' | translate }}
        </button>
        <button *ngIf="editingIndex === i" class="btn btn-sm btn-secondary me-1" (click)="annullaModifica()">
          {{ 'song_list.actions.cancel' | translate }}
        </button>
        <button class="btn btn-sm btn-danger" (click)="eliminaCanzone(canzone.id, i)">
          {{ 'song_list.actions.delete' | translate }}
        </button>
      </td>
      <td *ngIf="!canEditOrDelete(canzone)"></td>
    </tr>
  </tbody>
</table>

<!-- Reset lista giornaliera solo admin -->
<div class="mt-3" *ngIf="isAdmin">
  <button class="btn btn-danger" (click)="resetLista()">
    {{ 'song_list.actions.reset_list' | translate }}
  </button>
</div>
