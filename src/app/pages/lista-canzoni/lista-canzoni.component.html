<table class="table my-zebra-table">
  <thead>
    <tr>
      <th>{{ 'song_list.labels.status' | translate }}</th>
      <th>#</th>
      <th>{{ 'song_list.labels.name' | translate }}</th>
      <th>{{ 'song_list.labels.artist' | translate }}</th>
      <th>{{ 'song_list.labels.song' | translate }}</th>
      <th *ngIf="isAdmin">{{ 'song_list.labels.key' | translate }}</th>
      <th *ngIf="isAdmin">{{ 'song_list.labels.notes' | translate }}</th>
      <th>{{ 'song_list.labels.join' | translate }}</th>
      <th>{{ 'song_list.labels.vote' | translate }}</th>
      <th>{{ 'song_list.labels.wishlist' | translate }}</th>
      <th>{{ 'song_list.labels.actions' | translate }}</th>
    </tr>
  </thead>
  <tbody cdkDropList (cdkDropListDropped)="onDrop($event)">
    <tr cdkDrag *ngFor="let canzone of canzoni; let i = index" [id]="'canzone-' + canzone.id">
      
      <!-- Stato cantata -->
      <td>
        <button (click)="isAdmin && toggleCantata(i)"
                class="btn btn-sm"
                [disabled]="!isAdmin"
                [ngClass]="canzoni[i].cantata ? 'btn-danger' : 'btn-success'">
          {{ canzoni[i].cantata ? ('song_list.status_values.sung' | translate) : ('song_list.status_values.to_sing' | translate) }}
        </button>
      </td>

      <!-- Numero -->
      <td>{{ i + 1 }}</td>

      <!-- Nome -->
      <td *ngIf="editingIndex === i && editedCanzone as ec">
        <input [(ngModel)]="ec.nome" class="form-control form-control-sm" />
      </td>
      <td *ngIf="editingIndex !== i">{{ canzone.nome }}</td>

      <!-- Artista -->
      <td *ngIf="editingIndex === i && editedCanzone as ec">
        <input [(ngModel)]="ec.artista" class="form-control form-control-sm" />
      </td>
      <td *ngIf="editingIndex !== i">{{ canzone.artista }}</td>

      <!-- Canzone -->
      <td *ngIf="editingIndex === i && editedCanzone as ec">
        <input [(ngModel)]="ec.canzone" class="form-control form-control-sm" />
      </td>
      <td *ngIf="editingIndex !== i">{{ canzone.canzone }}</td>

      <!-- TonalitÃ  -->
      <td *ngIf="isAdmin">
        <ng-container *ngIf="editingIndex === i && editedCanzone as ec; else tonalitaStatic">
          <input [(ngModel)]="ec.tonalita" class="form-control form-control-sm" />
        </ng-container>
        <ng-template #tonalitaStatic>{{ canzone.tonalita }}</ng-template>
      </td>

      <!-- Note -->
      <td *ngIf="isAdmin">
        <ng-container *ngIf="editingIndex === i && editedCanzone as ec; else noteStatic">
          <input [(ngModel)]="ec.note" class="form-control form-control-sm" />
        </ng-container>
        <ng-template #noteStatic>{{ canzone.note }}</ng-template>
      </td>

      <!-- Partecipa -->
      <td>
        <button class="btn btn-success mb-1"
                [disabled]="!puoPartecipare || partecipazioneCompleta(canzone) || !canzone.accetta_partecipanti"
                (click)="partecipaAllaCanzone(canzone)">
          {{ 'song_list.labels.join' | translate }}
        </button>

        <div *ngIf="mostraInputPartecipazione[canzone.id]" class="mt-1">
          <input type="text"
                 [(ngModel)]="nomePartecipanteMap[canzone.id]"
                 placeholder="Il tuo nome"
                 class="form-control form-control-sm mb-1" />
          <button class="btn btn-primary btn-sm me-1" (click)="partecipaAllaCanzone(canzone)">Invia</button>
          <button class="btn btn-secondary btn-sm" (click)="mostraInputPartecipazione[canzone.id] = false">Annulla</button>
        </div>

        <div *ngIf="partecipazioneCompleta(canzone)" class="text-warning small mt-1">
          {{ 'song_list.participation.full' | translate }}
        </div>
        <div *ngIf="!canzone.accetta_partecipanti" class="text-muted small mt-1">
          {{ 'song_list.participation.not_available' | translate }}
        </div>
      </td>

      <!-- Emoji voto -->
      <td>
        <span *ngFor="let emoji of emojisVoto"
              (click)="votaCanzone(i, emoji.label)"
              [class.glow]="canzoni[i].votoEmoji === emoji.label"
              class="vote-icon"
              [title]="'song_list.labels.vote' | translate:{ emoji: emoji.label }">
          <i [ngClass]="'fa-solid ' + emoji.icon"></i>
        </span>
      </td>

      <!-- Wishlist -->
      <td>
        <button class="btn wishlist-btn" (click)="aggiungiAWishlist(canzone)">
          <i [ngClass]="canzone.inWishlist ? 'fa-solid fa-star active' : 'fa-solid fa-star'"></i>
        </button>
      </td>

      <!-- Azioni -->
      <td *ngIf="canEditOrDelete(canzone)">
        <button *ngIf="editingIndex !== i" class="btn btn-sm btn-warning me-1" (click)="modifica(i)">
          {{ 'song_list.actions.edit' | translate }}
        </button>
        <button *ngIf="editingIndex === i" class="btn btn-sm btn-success me-1" (click)="salvaModifica(i)">
          {{ 'song_list.actions.save' | translate }}
        </button>
        <button *ngIf="editingIndex === i" class="btn btn-sm btn-secondary me-1" (click)="annullaModifica()">
          {{ 'song_list.actions.cancel' | translate }}
        </button>
        <button class="btn btn-sm btn-danger" (click)="eliminaCanzone(canzone.id, i)">
          {{ 'song_list.actions.delete' | translate }}
        </button>
      </td>
      <td *ngIf="!canEditOrDelete(canzone)"></td>

      <!-- Drag preview -->
      <ng-template cdkDragPreview>
        <table class="drag-preview-table">
          <tbody>
            <tr>
              <td style="padding:14px 16px;">{{ canzone.cantata ? 'ðŸŽ¤' : '' }}</td>
              <td style="padding:14px 16px;">{{ i + 1 }}</td>
              <td style="padding:14px 16px;">{{ canzone.nome }}</td>
              <td style="padding:14px 16px;">{{ canzone.artista }}</td>
              <td style="padding:14px 16px;">{{ canzone.canzone }}</td>
              <td style="padding:14px 16px;" *ngIf="isAdmin">{{ canzone.tonalita }}</td>
              <td style="padding:14px 16px;" *ngIf="isAdmin">{{ canzone.note }}</td>
              <td style="padding:14px 16px;"></td>
              <td style="padding:14px 16px;">{{ canzone.votoEmoji || '' }}</td>
              <td style="padding:14px 16px;">
                <i [ngClass]="canzone.inWishlist ? 'fa-solid fa-star active' : 'fa-solid fa-star'"></i>
              </td>
              <td style="padding:14px 16px;"></td>
            </tr>
          </tbody>
        </table>
      </ng-template>

    </tr>
  </tbody>
</table>
